<!DOCTYPE html>

<html lang="en" data-content_root="./">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Pipeline &#8212; ReactionUtils 1.9.1 documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=5ecbeea2" />
    <link rel="stylesheet" type="text/css" href="_static/alabaster.css?v=a66d8bb5" />
    <script src="_static/documentation_options.js?v=60b3a732"></script>
    <script src="_static/doctools.js?v=9a2dae69"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Routes" href="routes.html" />
    <link rel="prev" title="Open reaction database" href="ord.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  <div class="document">
    
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="index.html">ReactionUtils</a></h1>



<p class="blurb">Utilities for working with reactions, reaction templates and template extraction</p>






<h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="templates.html">Templates</a></li>
<li class="toctree-l1"><a class="reference internal" href="uspto.html">USPTO</a></li>
<li class="toctree-l1"><a class="reference internal" href="ord.html">Open reaction database</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Pipeline</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#usage">Usage</a></li>
<li class="toctree-l2"><a class="reference internal" href="#actions">Actions</a></li>
<li class="toctree-l2"><a class="reference internal" href="#development">Development</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="routes.html">Routes</a></li>
<li class="toctree-l1"><a class="reference internal" href="rxnutils.html">rxnutils package</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
      <li>Previous: <a href="ord.html" title="previous chapter">Open reaction database</a></li>
      <li>Next: <a href="routes.html" title="next chapter">Routes</a></li>
  </ul></li>
</ul>
</div>
<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="pipeline">
<h1>Pipeline<a class="headerlink" href="#pipeline" title="Link to this heading">¶</a></h1>
<p><code class="docutils literal notranslate"><span class="pre">rxnutils</span></code> provide a simple pipeline to perform simple tasks on reaction SMILES and templates in a CSV-file.</p>
<p>The pipeline works on  <cite>tab-separated</cite> CSV files (TSV files)</p>
<section id="usage">
<h2>Usage<a class="headerlink" href="#usage" title="Link to this heading">¶</a></h2>
<p>To exemplify the pipeline capabilities, we will have a look at the pipeline used to clean the USPTO data.</p>
<p>The input to the pipeline is a simple YAML-file that specifies each action to take. The actions will be executed
sequentially, one after the other and each action takes a number of input arguments.</p>
<p>This is the YAML-file used to clean the USPTO data:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">trim_rxn_smiles</span><span class="p">:</span>
<span class="w">    </span><span class="nt">in_column</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ReactionSmiles</span>
<span class="w">    </span><span class="nt">out_column</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ReactionSmilesClean</span>
<span class="nt">remove_unsanitizable</span><span class="p">:</span>
<span class="w">    </span><span class="nt">in_column</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ReactionSmilesClean</span>
<span class="w">    </span><span class="nt">out_column</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ReactionSmilesClean</span>
<span class="nt">reagents2reactants</span><span class="p">:</span>
<span class="w">    </span><span class="nt">in_column</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ReactionSmilesClean</span>
<span class="w">    </span><span class="nt">out_column</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ReactionSmilesClean</span>
<span class="nt">remove_atom_mapping</span><span class="p">:</span>
<span class="w">    </span><span class="nt">in_column</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ReactionSmilesClean</span>
<span class="w">    </span><span class="nt">out_column</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ReactionSmilesClean</span>
<span class="nt">reactantsize</span><span class="p">:</span>
<span class="w">    </span><span class="nt">in_column</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ReactionSmilesClean</span>
<span class="nt">productsize</span><span class="p">:</span>
<span class="w">    </span><span class="nt">in_column</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ReactionSmilesClean</span>
<span class="nt">query_dataframe1</span><span class="p">:</span>
<span class="w">    </span><span class="nt">query</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;ReactantSize&gt;0&quot;</span>
<span class="nt">query_dataframe2</span><span class="p">:</span>
<span class="w">    </span><span class="nt">query</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;ProductSize&gt;0&quot;</span>
<span class="nt">query_dataframe3</span><span class="p">:</span>
<span class="w">    </span><span class="nt">query</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;ReactantSize+ProductSize&lt;200&quot;</span>
</pre></div>
</div>
<p>The first action is called <code class="docutils literal notranslate"><span class="pre">trim_rxn_smiles</span></code> and two arguments are given: <code class="docutils literal notranslate"><span class="pre">in_column</span></code> specifying which column to use as input and <code class="docutils literal notranslate"><span class="pre">out_column</span></code> specifying which column
to use as output.</p>
<p>The following actions <code class="docutils literal notranslate"><span class="pre">remove_unsanitizable</span></code>, <code class="docutils literal notranslate"><span class="pre">reagents2reactants</span></code>, <code class="docutils literal notranslate"><span class="pre">remove_atom_mapping</span></code>, <code class="docutils literal notranslate"><span class="pre">reactantsize</span></code>, <code class="docutils literal notranslate"><span class="pre">productsize</span></code> works the same way, but might use other columns to specified for output.</p>
<p>The last three actions are actually the same action but executed with different arguments. They therefore have to be postfixed with 1, 2 and 3.
The action <code class="docutils literal notranslate"><span class="pre">query_dataframe</span></code> takes a <code class="docutils literal notranslate"><span class="pre">query</span></code> argument and removes a number of rows not matching the query.</p>
<p>If we save this to <code class="docutils literal notranslate"><span class="pre">clean_pipeline.yml</span></code> and given that we have a tab-separated file with USPTO data called <code class="docutils literal notranslate"><span class="pre">uspto_data.csv</span></code> we can run the following command</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">python</span> <span class="o">-</span><span class="n">m</span> <span class="n">rxnutils</span><span class="o">.</span><span class="n">pipeline</span><span class="o">.</span><span class="n">runner</span> <span class="o">--</span><span class="n">pipeline</span> <span class="n">clean_pipeline</span><span class="o">.</span><span class="n">yml</span> <span class="o">--</span><span class="n">data</span> <span class="n">uspto_data</span><span class="o">.</span><span class="n">csv</span> <span class="o">--</span><span class="n">output</span> <span class="n">uspto_cleaned</span><span class="o">.</span><span class="n">csv</span>
</pre></div>
</div>
<p>or we can alternatively run it from a python method like this</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">rxnutils.pipeline.runner</span><span class="w"> </span><span class="kn">import</span> <span class="n">main</span> <span class="k">as</span> <span class="n">validation_runner</span>

<span class="n">validation_runner</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="s2">&quot;--pipeline&quot;</span><span class="p">,</span>
        <span class="s2">&quot;clean_pipeline.yml&quot;</span><span class="p">,</span>
        <span class="s2">&quot;--data&quot;</span><span class="p">,</span>
        <span class="s2">&quot;uspto_data.csv&quot;</span><span class="p">,</span>
        <span class="s2">&quot;--output&quot;</span><span class="p">,</span>
        <span class="s2">&quot;uspto_cleaned.csv&quot;</span><span class="p">,</span>
    <span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
</section>
<section id="actions">
<h2>Actions<a class="headerlink" href="#actions" title="Link to this heading">¶</a></h2>
<p>To find out what actions are available, you can type</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">python</span> <span class="o">-</span><span class="n">m</span> <span class="n">rxnutils</span><span class="o">.</span><span class="n">pipeline</span><span class="o">.</span><span class="n">runner</span> <span class="o">--</span><span class="nb">list</span>
</pre></div>
</div>
</section>
<section id="development">
<h2>Development<a class="headerlink" href="#development" title="Link to this heading">¶</a></h2>
<p>New actions can easily be added to the pipeline framework. All of the actions are implemented in one of four modules</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">rxnutils.pipeline.actions.dataframe_mod</span></code> - actions that modify the dataframe, e.g., removing rows or columns</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">rxnutils.pipeline.actions.reaction_mod</span></code> - actions that modify reaction SMILES</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">rxnutils.pipeline.actions.dataframe_props</span></code> - actions that compute properties from reaction SMILES</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">rxnutils.pipeline.actions.templates</span></code> - actions that process reaction templates</p></li>
</ul>
</div></blockquote>
<p>To exemplify, let’s have a look at the <code class="docutils literal notranslate"><span class="pre">productsize</span></code> action</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@action</span>
<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ProductSize</span><span class="p">:</span>
<span class="sd">&quot;&quot;&quot;Action for counting product size&quot;&quot;&quot;</span>

<span class="n">pretty_name</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;productsize&quot;</span>
<span class="n">in_column</span><span class="p">:</span> <span class="nb">str</span>
<span class="n">out_column</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;ProductSize&quot;</span>

<span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
    <span class="n">smiles_col</span> <span class="o">=</span> <span class="n">global_apply</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_row_action</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">data</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">out_column</span><span class="p">:</span> <span class="n">smiles_col</span><span class="p">})</span>

<span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">pretty_name</span><span class="si">}</span><span class="s2"> (number of heavy atoms in product)&quot;</span>

<span class="k">def</span><span class="w"> </span><span class="nf">_row_action</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">products</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">in_column</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;&gt;&quot;</span><span class="p">)</span>
    <span class="n">products_mol</span> <span class="o">=</span> <span class="n">Chem</span><span class="o">.</span><span class="n">MolFromSmiles</span><span class="p">(</span><span class="n">products</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">products_mol</span><span class="p">:</span>
        <span class="n">product_atom_count</span> <span class="o">=</span> <span class="n">products_mol</span><span class="o">.</span><span class="n">GetNumHeavyAtoms</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">product_atom_count</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">return</span> <span class="n">product_atom_count</span>
</pre></div>
</div>
<p>The action is defined as a class <code class="docutils literal notranslate"><span class="pre">ProductSize</span></code> that has two class-decorators.
The first <code class="docutils literal notranslate"><span class="pre">&#64;action</span></code> will register the action in a global action list and second <code class="docutils literal notranslate"><span class="pre">&#64;dataclass</span></code> is dataclass decorator from the standard library.
The <code class="docutils literal notranslate"><span class="pre">pretty_name</span></code> class variable is used to identify the action in the pipeline, that is what you are specifying in the YAML-file.
The other two <code class="docutils literal notranslate"><span class="pre">in_column</span></code> and <code class="docutils literal notranslate"><span class="pre">out_column</span></code> are the arguments you can specify in the YAML file for executing the action, they can have default
values in case they don’t need to be specified in the YAML file.</p>
<p>When the action is executed by the pipeline the <code class="docutils literal notranslate"><span class="pre">__call__</span></code> method is invoked with the current Pandas dataframe as the only argument. This method
should return the modified dataframe.</p>
<p>Lastly, it is nice to implement a <code class="docutils literal notranslate"><span class="pre">__str__</span></code> method which is used by the pipeline to print useful information about the action that is executed.</p>
</section>
</section>


          </div>
          
        </div>
      </div>
    <div class="clearer"></div>
  </div>
    <div class="footer">
      &#169;2022-2025, Molecular AI group.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 7.4.7</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 0.7.16</a>
      
      |
      <a href="_sources/pipeline.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>